#include "mpack-array.h"
#include "objects/array-objects.h"
#include <cstdint>
#include <gtest/gtest.h>
#include <string>
#include <vector>

static std::vector<uint8_t> writeArrays(ObjectWithArrays &inObj) {
  mpack_writer_t w;
  char *buf = nullptr;
  size_t size = 0;

  mpack_writer_init_growable(&w, &buf, &size);

  inObj.write(w, 0);

  EXPECT_EQ(mpack_writer_destroy(&w), mpack_ok);

  std::vector<uint8_t> out(reinterpret_cast<uint8_t *>(buf),
                           reinterpret_cast<uint8_t *>(buf) + size);
  MPACK_FREE(buf);
  return out;
}

static std::vector<uint8_t> bytes_arrays_case1 = {
    0x8c, 0xa3, 0x69, 0x36, 0x34, 0x93, 0x01, 0xfe, 0xcd, 0x01, 0x2c, 0xa3,
    0x75, 0x36, 0x34, 0x93, 0x00, 0xce, 0x00, 0x01, 0x5f, 0x90, 0xcf, 0x00,
    0x00, 0x00, 0x01, 0xa1, 0x3b, 0x86, 0x00, 0xa3, 0x66, 0x33, 0x32, 0x92,
    0xca, 0x40, 0x50, 0x00, 0x00, 0xca, 0xbf, 0x00, 0x00, 0x00, 0xa3, 0x66,
    0x36, 0x34, 0x92, 0xcb, 0xc1, 0xd2, 0x54, 0x13, 0xe0, 0x00, 0x00, 0x00,
    0xcb, 0x44, 0xdf, 0xe1, 0x85, 0xca, 0x57, 0xc5, 0x17, 0xa2, 0x73, 0x73,
    0x93, 0xa5, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0xa9, 0x55, 0x54, 0x46, 0x2d,
    0x38, 0x20, 0xe2, 0x9c, 0x93, 0xa0, 0xa4, 0x6f, 0x62, 0x6a, 0x73, 0x92,
    0x82, 0xa1, 0x61, 0xf6, 0xa1, 0x62, 0x14, 0x82, 0xa1, 0x61, 0x00, 0xa1,
    0x62, 0x2a, 0xa2, 0x61, 0x61, 0x92, 0x93, 0x01, 0x02, 0x03, 0x92, 0xfc,
    0xfb, 0xa6, 0x61, 0x61, 0x5f, 0x66, 0x36, 0x34, 0x90, 0xa7, 0x61, 0x61,
    0x5f, 0x62, 0x6f, 0x6f, 0x6c, 0x90, 0xa7, 0x61, 0x61, 0x5f, 0x6f, 0x62,
    0x6a, 0x73, 0x90, 0xa5, 0x61, 0x61, 0x5f, 0x73, 0x73, 0x90, 0xa7, 0x61,
    0x61, 0x61, 0x5f, 0x66, 0x33, 0x32, 0x90};

static std::vector<uint8_t> bytes_arrays_case2 = {
    0x8c, 0xa3, 0x69, 0x36, 0x34, 0x95, 0xff, 0x02, 0xfd, 0x04, 0xfb, 0xa3,
    0x75, 0x36, 0x34, 0x95, 0x01, 0x02, 0x03, 0x04, 0x05, 0xa3, 0x66, 0x33,
    0x32, 0x94, 0xca, 0x3f, 0x80, 0x00, 0x00, 0xca, 0xbf, 0x80, 0x00, 0x00,
    0xca, 0x3f, 0xc0, 0x00, 0x00, 0xca, 0xc0, 0x30, 0x00, 0x00, 0xa3, 0x66,
    0x36, 0x34, 0x94, 0xcb, 0x40, 0x09, 0x21, 0xfb, 0x54, 0x44, 0x2d, 0x18,
    0xcb, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xcb, 0x01, 0xa5,
    0x6e, 0x1f, 0xc2, 0xf8, 0xf3, 0x59, 0xcb, 0x7e, 0x37, 0xe4, 0x3c, 0x88,
    0x00, 0x75, 0x9c, 0xa2, 0x73, 0x73, 0x92, 0xd9, 0x20, 0x73, 0x79, 0x6d,
    0x62, 0x6f, 0x6c, 0x73, 0x20, 0x21, 0x40, 0x23, 0x24, 0x20, 0x22, 0x71,
    0x75, 0x6f, 0x74, 0x65, 0x22, 0x20, 0x5c, 0x20, 0x62, 0x61, 0x63, 0x6b,
    0x73, 0x6c, 0x61, 0x73, 0x68, 0xae, 0x6d, 0x75, 0x6c, 0x74, 0x69, 0x6c,
    0x69, 0x6e, 0x65, 0x0a, 0x74, 0x65, 0x78, 0x74, 0xa4, 0x6f, 0x62, 0x6a,
    0x73, 0x91, 0x82, 0xa1, 0x61, 0x7b, 0xa1, 0x62, 0xcd, 0x01, 0xc8, 0xa2,
    0x61, 0x61, 0x93, 0x90, 0x91, 0x0a, 0x92, 0x14, 0x1e, 0xa6, 0x61, 0x61,
    0x5f, 0x66, 0x36, 0x34, 0x90, 0xa7, 0x61, 0x61, 0x5f, 0x62, 0x6f, 0x6f,
    0x6c, 0x90, 0xa7, 0x61, 0x61, 0x5f, 0x6f, 0x62, 0x6a, 0x73, 0x90, 0xa5,
    0x61, 0x61, 0x5f, 0x73, 0x73, 0x90, 0xa7, 0x61, 0x61, 0x61, 0x5f, 0x66,
    0x33, 0x32, 0x90};

static std::vector<uint8_t> bytes_arrays_case3 = {
    0x8c, 0xa3, 0x69, 0x36, 0x34, 0x93, 0x01, 0xfe, 0x03, 0xa3, 0x75, 0x36,
    0x34, 0x90, 0xa3, 0x66, 0x33, 0x32, 0x90, 0xa3, 0x66, 0x36, 0x34, 0x90,
    0xa2, 0x73, 0x73, 0x90, 0xa4, 0x6f, 0x62, 0x6a, 0x73, 0x90, 0xa2, 0x61,
    0x61, 0x90, 0xa6, 0x61, 0x61, 0x5f, 0x66, 0x36, 0x34, 0x90, 0xa7, 0x61,
    0x61, 0x5f, 0x62, 0x6f, 0x6f, 0x6c, 0x90, 0xa7, 0x61, 0x61, 0x5f, 0x6f,
    0x62, 0x6a, 0x73, 0x90, 0xa5, 0x61, 0x61, 0x5f, 0x73, 0x73, 0x90, 0xa7,
    0x61, 0x61, 0x61, 0x5f, 0x66, 0x33, 0x32, 0x90};

static std::vector<uint8_t> bytes_arrays_case4 = {
    0x8c, 0xa3, 0x69, 0x36, 0x34, 0x90, 0xa3, 0x75, 0x36, 0x34, 0x92,
    0x00, 0xcf, 0x11, 0x22, 0x10, 0xf4, 0x7d, 0xe9, 0x81, 0x15, 0xa3,
    0x66, 0x33, 0x32, 0x90, 0xa3, 0x66, 0x36, 0x34, 0x90, 0xa2, 0x73,
    0x73, 0x90, 0xa4, 0x6f, 0x62, 0x6a, 0x73, 0x90, 0xa2, 0x61, 0x61,
    0x90, 0xa6, 0x61, 0x61, 0x5f, 0x66, 0x36, 0x34, 0x90, 0xa7, 0x61,
    0x61, 0x5f, 0x62, 0x6f, 0x6f, 0x6c, 0x90, 0xa7, 0x61, 0x61, 0x5f,
    0x6f, 0x62, 0x6a, 0x73, 0x90, 0xa5, 0x61, 0x61, 0x5f, 0x73, 0x73,
    0x90, 0xa7, 0x61, 0x61, 0x61, 0x5f, 0x66, 0x33, 0x32, 0x90};

static std::vector<uint8_t> bytes_arrays_case5 = {
    0x8c, 0xa3, 0x69, 0x36, 0x34, 0x90, 0xa3, 0x75, 0x36, 0x34, 0x90, 0xa3,
    0x66, 0x33, 0x32, 0x93, 0xca, 0x00, 0x00, 0x00, 0x00, 0xca, 0x3f, 0x80,
    0x00, 0x00, 0xca, 0xc0, 0x20, 0x00, 0x00, 0xa3, 0x66, 0x36, 0x34, 0x90,
    0xa2, 0x73, 0x73, 0x90, 0xa4, 0x6f, 0x62, 0x6a, 0x73, 0x90, 0xa2, 0x61,
    0x61, 0x90, 0xa6, 0x61, 0x61, 0x5f, 0x66, 0x36, 0x34, 0x90, 0xa7, 0x61,
    0x61, 0x5f, 0x62, 0x6f, 0x6f, 0x6c, 0x90, 0xa7, 0x61, 0x61, 0x5f, 0x6f,
    0x62, 0x6a, 0x73, 0x90, 0xa5, 0x61, 0x61, 0x5f, 0x73, 0x73, 0x90, 0xa7,
    0x61, 0x61, 0x61, 0x5f, 0x66, 0x33, 0x32, 0x90};

static std::vector<uint8_t> bytes_arrays_case6 = {
    0x8c, 0xa3, 0x69, 0x36, 0x34, 0x90, 0xa3, 0x75, 0x36, 0x34, 0x90, 0xa3,
    0x66, 0x33, 0x32, 0x90, 0xa3, 0x66, 0x36, 0x34, 0x92, 0xcb, 0x2b, 0x2b,
    0xff, 0x2e, 0xe4, 0x8e, 0x05, 0x30, 0xcb, 0xd4, 0xb2, 0x49, 0xad, 0x25,
    0x94, 0xc3, 0x7d, 0xa2, 0x73, 0x73, 0x90, 0xa4, 0x6f, 0x62, 0x6a, 0x73,
    0x90, 0xa2, 0x61, 0x61, 0x90, 0xa6, 0x61, 0x61, 0x5f, 0x66, 0x36, 0x34,
    0x90, 0xa7, 0x61, 0x61, 0x5f, 0x62, 0x6f, 0x6f, 0x6c, 0x90, 0xa7, 0x61,
    0x61, 0x5f, 0x6f, 0x62, 0x6a, 0x73, 0x90, 0xa5, 0x61, 0x61, 0x5f, 0x73,
    0x73, 0x90, 0xa7, 0x61, 0x61, 0x61, 0x5f, 0x66, 0x33, 0x32, 0x90};

static std::vector<uint8_t> bytes_arrays_case7 = {
    0x8c, 0xa3, 0x69, 0x36, 0x34, 0x90, 0xa3, 0x75, 0x36, 0x34, 0x90,
    0xa3, 0x66, 0x33, 0x32, 0x90, 0xa3, 0x66, 0x36, 0x34, 0x90, 0xa2,
    0x73, 0x73, 0x92, 0xa8, 0x6f, 0x6e, 0x6c, 0x79, 0x2d, 0x6f, 0x6e,
    0x65, 0xa0, 0xa4, 0x6f, 0x62, 0x6a, 0x73, 0x90, 0xa2, 0x61, 0x61,
    0x90, 0xa6, 0x61, 0x61, 0x5f, 0x66, 0x36, 0x34, 0x90, 0xa7, 0x61,
    0x61, 0x5f, 0x62, 0x6f, 0x6f, 0x6c, 0x90, 0xa7, 0x61, 0x61, 0x5f,
    0x6f, 0x62, 0x6a, 0x73, 0x90, 0xa5, 0x61, 0x61, 0x5f, 0x73, 0x73,
    0x90, 0xa7, 0x61, 0x61, 0x61, 0x5f, 0x66, 0x33, 0x32, 0x90};

static std::vector<uint8_t> bytes_arrays_case8 = {
    0x8C, 0xA3, 0x69, 0x36, 0x34, 0x90, 0xA3, 0x75, 0x36, 0x34, 0x90, 0xA3,
    0x66, 0x33, 0x32, 0x90, 0xA3, 0x66, 0x36, 0x34, 0x90, 0xA2, 0x73, 0x73,
    0x90, 0xA4, 0x6F, 0x62, 0x6A, 0x73, 0x92, 0x82, 0xA1, 0x61, 0x01, 0xA1,
    0x62, 0x02, 0x82, 0xA1, 0x61, 0xFD, 0xA1, 0x62, 0x04, 0xA2, 0x61, 0x61,
    0x90, 0xA6, 0x61, 0x61, 0x5F, 0x66, 0x36, 0x34, 0x90, 0xA7, 0x61, 0x61,
    0x5F, 0x62, 0x6F, 0x6F, 0x6C, 0x90, 0xA7, 0x61, 0x61, 0x5F, 0x6F, 0x62,
    0x6A, 0x73, 0x90, 0xA5, 0x61, 0x61, 0x5F, 0x73, 0x73, 0x90, 0xA7, 0x61,
    0x61, 0x61, 0x5F, 0x66, 0x33, 0x32, 0x90};

static std::vector<uint8_t> bytes_arrays_case9 = {
    0x8C, 0xA3, 0x69, 0x36, 0x34, 0x90, 0xA3, 0x75, 0x36, 0x34, 0x90, 0xA3,
    0x66, 0x33, 0x32, 0x90, 0xA3, 0x66, 0x36, 0x34, 0x90, 0xA2, 0x73, 0x73,
    0x90, 0xA4, 0x6F, 0x62, 0x6A, 0x73, 0x90, 0xA2, 0x61, 0x61, 0x93, 0x93,
    0x01, 0x02, 0x03, 0x90, 0x91, 0xFF, 0xA6, 0x61, 0x61, 0x5F, 0x66, 0x36,
    0x34, 0x90, 0xA7, 0x61, 0x61, 0x5F, 0x62, 0x6F, 0x6F, 0x6C, 0x90, 0xA7,
    0x61, 0x61, 0x5F, 0x6F, 0x62, 0x6A, 0x73, 0x90, 0xA5, 0x61, 0x61, 0x5F,
    0x73, 0x73, 0x90, 0xA7, 0x61, 0x61, 0x61, 0x5F, 0x66, 0x33, 0x32, 0x90};

static std::vector<uint8_t> bytes_arrays_case10 = {
    0x8c, 0xa3, 0x69, 0x36, 0x34, 0x93, 0x01, 0xfe, 0x03, 0xa3, 0x75, 0x36,
    0x34, 0x92, 0x00, 0xce, 0x3b, 0x9a, 0xc9, 0xff, 0xa3, 0x66, 0x33, 0x32,
    0x92, 0xca, 0x3f, 0x80, 0x00, 0x00, 0xca, 0xc0, 0x20, 0x00, 0x00, 0xa3,
    0x66, 0x36, 0x34, 0x92, 0xcb, 0x40, 0x09, 0x21, 0xfb, 0x54, 0x44, 0x2d,
    0x18, 0xcb, 0xd4, 0xb2, 0x49, 0xad, 0x25, 0x94, 0xc3, 0x7d, 0xa2, 0x73,
    0x73, 0x93, 0xa4, 0x72, 0x6f, 0x6f, 0x74, 0xa6, 0x6e, 0x65, 0x73, 0x74,
    0x65, 0x64, 0xa0, 0xa4, 0x6f, 0x62, 0x6a, 0x73, 0x92, 0x82, 0xa1, 0x61,
    0xff, 0xa1, 0x62, 0x00, 0x82, 0xa1, 0x61, 0x00, 0xa1, 0x62, 0x2a, 0xa2,
    0x61, 0x61, 0x93, 0x90, 0x93, 0x01, 0x02, 0x03, 0x92, 0xf6, 0xec, 0xa6,
    0x61, 0x61, 0x5f, 0x66, 0x36, 0x34, 0x93, 0x93, 0xcb, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xcb, 0x3f, 0xf8, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xcb, 0xc0, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x90,
    0x92, 0xcb, 0x3d, 0xdb, 0x7c, 0xdf, 0xd9, 0xd7, 0xbd, 0xbb, 0xcb, 0xbd,
    0xdb, 0x7c, 0xdf, 0xd9, 0xd7, 0xbd, 0xbb, 0xa7, 0x61, 0x61, 0x5f, 0x62,
    0x6f, 0x6f, 0x6c, 0x93, 0x93, 0xc3, 0xc2, 0xc3, 0x90, 0x91, 0xc2, 0xa7,
    0x61, 0x61, 0x5f, 0x6f, 0x62, 0x6a, 0x73, 0x93, 0x92, 0x82, 0xa1, 0x61,
    0x01, 0xa1, 0x62, 0x01, 0x82, 0xa1, 0x61, 0x02, 0xa1, 0x62, 0x02, 0x90,
    0x91, 0x82, 0xa1, 0x61, 0xd0, 0x9c, 0xa1, 0x62, 0xce, 0x00, 0x01, 0xe2,
    0x40, 0xa5, 0x61, 0x61, 0x5f, 0x73, 0x73, 0x93, 0x93, 0xa4, 0x72, 0x6f,
    0x6f, 0x74, 0xa4, 0x72, 0x6f, 0x6f, 0x74, 0xa4, 0x72, 0x6f, 0x6f, 0x74,
    0x90, 0x92, 0xa0, 0xa0, 0xa7, 0x61, 0x61, 0x61, 0x5f, 0x66, 0x33, 0x32,
    0x93, 0x92, 0x91, 0xca, 0x3f, 0x80, 0x00, 0x00, 0x92, 0xca, 0x40, 0x00,
    0x00, 0x00, 0xca, 0x40, 0x40, 0x00, 0x00, 0x90, 0x92, 0x93, 0xca, 0xbf,
    0xc0, 0x00, 0x00, 0xca, 0xc0, 0x20, 0x00, 0x00, 0xca, 0xc0, 0x60, 0x00,
    0x00, 0x91, 0xca, 0x00, 0x00, 0x00, 0x00};

static std::vector<uint8_t> bytes_arrays_case11 = {
    0x8c, 0xa3, 0x69, 0x36, 0x34, 0x90, 0xa3, 0x75, 0x36, 0x34, 0x90, 0xa3,
    0x66, 0x33, 0x32, 0x90, 0xa3, 0x66, 0x36, 0x34, 0x92, 0xcb, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xcb, 0x80, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xa2, 0x73, 0x73, 0x93, 0xa0, 0xa4, 0x64, 0x65, 0x65,
    0x70, 0xa6, 0x64, 0x65, 0x65, 0x70, 0x65, 0x72, 0xa4, 0x6f, 0x62, 0x6a,
    0x73, 0x90, 0xa2, 0x61, 0x61, 0x93, 0x94, 0x64, 0xcc, 0xc8, 0xcd, 0x01,
    0x2c, 0xcd, 0x01, 0x90, 0x90, 0x95, 0xff, 0xff, 0xff, 0xff, 0xff, 0xa6,
    0x61, 0x61, 0x5f, 0x66, 0x36, 0x34, 0x93, 0x94, 0xcb, 0x3f, 0xf0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xcb, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xcb, 0x40, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xcb,
    0x40, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x92, 0xcb, 0x3f, 0x50,
    0x62, 0x4d, 0xd2, 0xf1, 0xa9, 0xfc, 0xcb, 0x40, 0x8f, 0x40, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x90, 0xa7, 0x61, 0x61, 0x5f, 0x62, 0x6f, 0x6f, 0x6c,
    0x93, 0x91, 0xc3, 0x94, 0xc2, 0xc2, 0xc3, 0xc2, 0x90, 0xa7, 0x61, 0x61,
    0x5f, 0x6f, 0x62, 0x6a, 0x73, 0x91, 0x93, 0x82, 0xa1, 0x61, 0x07, 0xa1,
    0x62, 0x07, 0x82, 0xa1, 0x61, 0x08, 0xa1, 0x62, 0x08, 0x82, 0xa1, 0x61,
    0x09, 0xa1, 0x62, 0x09, 0xa5, 0x61, 0x61, 0x5f, 0x73, 0x73, 0x93, 0x92,
    0xa0, 0xa0, 0x90, 0x94, 0xa6, 0x64, 0x65, 0x65, 0x70, 0x65, 0x72, 0xa6,
    0x64, 0x65, 0x65, 0x70, 0x65, 0x72, 0xa6, 0x64, 0x65, 0x65, 0x70, 0x65,
    0x72, 0xa6, 0x64, 0x65, 0x65, 0x70, 0x65, 0x72, 0xa7, 0x61, 0x61, 0x61,
    0x5f, 0x66, 0x33, 0x32, 0x93, 0x93, 0x92, 0xca, 0x00, 0x00, 0x00, 0x00,
    0xca, 0x3f, 0x80, 0x00, 0x00, 0x93, 0xca, 0xbf, 0x80, 0x00, 0x00, 0xca,
    0xc0, 0x00, 0x00, 0x00, 0xca, 0xc0, 0x40, 0x00, 0x00, 0x91, 0xca, 0x41,
    0x20, 0x00, 0x00, 0x93, 0x90, 0x92, 0xca, 0x40, 0x48, 0xf5, 0xc3, 0xca,
    0x40, 0x2d, 0x70, 0xa4, 0x94, 0xca, 0x42, 0x28, 0x00, 0x00, 0xca, 0xc2,
    0x28, 0x00, 0x00, 0xca, 0x00, 0x00, 0x00, 0x00, 0xca, 0x3f, 0x00, 0x00,
    0x00, 0x90};

struct ArrayWriteCase {
  std::string name;
  std::vector<uint8_t> expected;
  std::vector<int64_t> i64;
  std::vector<uint64_t> u64;
  std::vector<float> f32;
  std::vector<double> f64;
  std::vector<std::string> ss;
  std::vector<std::pair<int32_t, uint32_t>> objs;
  std::vector<std::vector<int32_t>> aa;
  std::vector<std::vector<double>> aa_f64;
  std::vector<std::vector<bool>> aa_bool;
  std::vector<std::vector<std::pair<int32_t, uint32_t>>> aa_objs;
  std::vector<std::vector<std::string>> aa_ss;
  std::vector<std::vector<std::vector<float>>> aaa_f32;
};

class ObjectWithArraysWriteTest
    : public ::testing::TestWithParam<ArrayWriteCase> {};

TEST_P(ObjectWithArraysWriteTest, EncodesAllArrays) {
  const auto &tc = GetParam();

  ObjectWithArrays obj;

  obj.i64.size = tc.i64.size();
  obj.i64.p = obj.i64.size ? new int64_t[obj.i64.size] : new int64_t[0];
  for (size_t i = 0; i < tc.i64.size(); ++i)
    obj.i64[i] = tc.i64[i];

  obj.u64.size = tc.u64.size();
  obj.u64.p = obj.u64.size ? new uint64_t[obj.u64.size] : new uint64_t[0];
  for (size_t i = 0; i < tc.u64.size(); ++i)
    obj.u64[i] = tc.u64[i];

  obj.f32.size = tc.f32.size();
  obj.f32.p = obj.f32.size ? new float[obj.f32.size] : new float[0];
  for (size_t i = 0; i < tc.f32.size(); ++i)
    obj.f32[i] = tc.f32[i];

  obj.f64.size = tc.f64.size();
  obj.f64.p = obj.f64.size ? new double[obj.f64.size] : new double[0];
  for (size_t i = 0; i < tc.f64.size(); ++i)
    obj.f64[i] = tc.f64[i];

  obj.ss.size = tc.ss.size();
  obj.ss.p = obj.ss.size ? new const char *[obj.ss.size] : new const char *[0];
  for (size_t i = 0; i < tc.ss.size(); ++i) {
    char *buf = new char[tc.ss[i].size() + 1];
    memcpy(buf, tc.ss[i].c_str(), tc.ss[i].size() + 1); // copies '\0' too
    obj.ss[i] = buf;
  }

  obj.objs.size = tc.objs.size();
  obj.objs.p = obj.objs.size ? new Elem *[obj.objs.size] : new Elem *[0];
  for (size_t i = 0; i < tc.objs.size(); ++i) {
    auto *e = new Elem();
    e->a = tc.objs[i].first;
    e->b = tc.objs[i].second;
    obj.objs[i] = e;
  }

  obj.aa.size = tc.aa.size();
  obj.aa.p = obj.aa.size ? new MPackArray<int32_t>[obj.aa.size]
                         : new MPackArray<int32_t>[0];
  for (size_t i = 0; i < tc.aa.size(); ++i) {
    auto &inner = obj.aa[i];
    inner.size = tc.aa[i].size();
    inner.p = inner.size ? new int32_t[inner.size] : new int32_t[0];
    for (size_t j = 0; j < tc.aa[i].size(); ++j)
      inner[j] = tc.aa[i][j];
  }

  obj.aa_f64.size = tc.aa_f64.size();
  obj.aa_f64.p = obj.aa_f64.size ? new MPackArray<double>[obj.aa_f64.size]
                                 : new MPackArray<double>[0];
  for (size_t i = 0; i < tc.aa_f64.size(); ++i) {
    auto &inner = obj.aa_f64[i];
    inner.size = tc.aa_f64[i].size();
    inner.p = inner.size ? new double[inner.size] : new double[0];
    for (size_t j = 0; j < tc.aa_f64[i].size(); ++j)
      inner[j] = tc.aa_f64[i][j];
  }

  obj.aa_bool.size = tc.aa_bool.size();
  obj.aa_bool.p = obj.aa_bool.size ? new MPackArray<bool>[obj.aa_bool.size]
                                   : new MPackArray<bool>[0];
  for (size_t i = 0; i < tc.aa_bool.size(); ++i) {
    auto &inner = obj.aa_bool[i];
    inner.size = tc.aa_bool[i].size();
    inner.p = inner.size ? new bool[inner.size] : new bool[0];
    for (size_t j = 0; j < tc.aa_bool[i].size(); ++j)
      inner[j] = tc.aa_bool[i][j];
  }

  obj.aa_objs.size = tc.aa_objs.size();
  obj.aa_objs.p = obj.aa_objs.size ? new MPackArray<Elem *>[obj.aa_objs.size]
                                   : new MPackArray<Elem *>[0];
  for (size_t i = 0; i < tc.aa_objs.size(); ++i) {
    auto &inner = obj.aa_objs[i];
    inner.size = tc.aa_objs[i].size();
    inner.p = inner.size ? new Elem *[inner.size] : new Elem *[0];
    for (size_t j = 0; j < tc.aa_objs[i].size(); ++j) {
      auto *e = new Elem();
      e->a = tc.aa_objs[i][j].first;
      e->b = tc.aa_objs[i][j].second;
      inner[j] = e;
    }
  }

  obj.aa_ss.size = tc.aa_ss.size();
  obj.aa_ss.p = obj.aa_ss.size ? new MPackArray<const char *>[obj.aa_ss.size]
                               : new MPackArray<const char *>[0];
  for (size_t i = 0; i < tc.aa_ss.size(); ++i) {
    auto &inner = obj.aa_ss[i];
    inner.size = tc.aa_ss[i].size();
    inner.p = inner.size ? new const char *[inner.size] : new const char *[0];
    for (size_t j = 0; j < tc.aa_ss[i].size(); ++j) {
      char *buf = new char[tc.ss[i].size() + 1];
      memcpy(buf, tc.ss[i].c_str(), tc.ss[i].size() + 1);
      inner[j] = buf;
    }
  }

  obj.aaa_f32.size = tc.aaa_f32.size();
  obj.aaa_f32.p = obj.aaa_f32.size
                      ? new MPackArray<MPackArray<float>>[obj.aaa_f32.size]
                      : new MPackArray<MPackArray<float>>[0];
  for (size_t i = 0; i < tc.aaa_f32.size(); ++i) {
    auto &mid = obj.aaa_f32[i];
    mid.size = tc.aaa_f32[i].size();
    mid.p =
        mid.size ? new MPackArray<float>[mid.size] : new MPackArray<float>[0];
    for (size_t j = 0; j < tc.aaa_f32[i].size(); ++j) {
      auto &inner = mid[j];
      inner.size = tc.aaa_f32[i][j].size();
      inner.p = inner.size ? new float[inner.size] : new float[0];
      for (size_t k = 0; k < tc.aaa_f32[i][j].size(); ++k)
        inner[k] = tc.aaa_f32[i][j][k];
    }
  }

  auto bytes = writeArrays(obj);
  EXPECT_EQ(bytes, tc.expected);
}

struct ArrayWriteCaseName {
  template <class ParamType>
  std::string
  operator()(const ::testing::TestParamInfo<ParamType> &info) const {
    return info.param.name;
  }
};

INSTANTIATE_TEST_SUITE_P(
    MPackAllArraysWrite, ObjectWithArraysWriteTest,
    ::testing::Values(
        ArrayWriteCase{
            "MixOfAllArrays1",
            bytes_arrays_case1,
            {1, -2, 300},                    // i64
            {0ULL, 90000ULL, 7000000000ULL}, // u64
            {3.25f, -0.5f},                  // f32
            {-1230000000.0, 6.02214076e23},  // f64
            {"hello", "UTF-8 âœ“", ""},        // ss
            {{-10, 20u}, {0, 42u}},          // objs
            {{1, 2, 3}, {-4, -5}},           // aa
            {},                              // aa_f64
            {},                              // aa_bool
            {},                              // aa_objs
            {},                              // aa_ss
            {}                               // aaa_f32
        },
        ArrayWriteCase{
            "MixOfAllArrays2",
            bytes_arrays_case2,
            {-1, 2, -3, 4, -5},                                         // i64
            {1ULL, 2ULL, 3ULL, 4ULL, 5ULL},                             // u64
            {1.0f, -1.0f, 1.5f, -2.75f},                                // f32
            {3.141592653589793, 0.0, 1e-300, 1e300},                    // f64
            {"symbols !@#$ \"quote\" \\ backslash", "multiline\ntext"}, // ss
            {{123, 456u}},                                              // objs
            {{}, {10}, {20, 30}},                                       // aa
            {},
            {},
            {},
            {},
            {} // nested fields empty
        },
        ArrayWriteCase{
            "ArrayOfI64",
            bytes_arrays_case3,
            {1, -2, 3}, // i64
            {},
            {},
            {}, // u64, f32, f64
            {}, // ss
            {}, // objs
            {}, // aa
            {},
            {},
            {},
            {},
            {} // nested fields
        },
        ArrayWriteCase{
            "ArrayOfU64",
            bytes_arrays_case4,
            {},                             // i64
            {0ULL, 1234567890123456789ULL}, // u64
            {},
            {}, // f32, f64
            {}, // ss
            {}, // objs
            {}, // aa
            {},
            {},
            {},
            {},
            {} // nested fields
        },
        ArrayWriteCase{
            "ArrayOfFloats",
            bytes_arrays_case5,
            {},                  // i64
            {},                  // u64
            {0.0f, 1.0f, -2.5f}, // f32
            {},                  // f64
            {},                  // ss
            {},                  // objs
            {},                  // aa
            {},
            {},
            {},
            {},
            {} // nested fields
        },
        ArrayWriteCase{
            "ArrayOfDoubles",
            bytes_arrays_case6,
            {},                   // i64
            {},                   // u64
            {},                   // f32
            {1.0e-100, -1.0e100}, // f64
            {},                   // ss
            {},                   // objs
            {},                   // aa
            {},
            {},
            {},
            {},
            {} // nested fields
        },
        ArrayWriteCase{
            "ArrayOfStrings",
            bytes_arrays_case7,
            {}, // i64
            {},
            {},
            {},               // u64, f32, f64
            {"only-one", ""}, // ss
            {},               // objs
            {},               // aa
            {},
            {},
            {},
            {},
            {} // nested fields
        },
        ArrayWriteCase{
            "ArrayOfObjects",
            bytes_arrays_case8,
            {}, // i64
            {},
            {},
            {},                  // u64, f32, f64
            {},                  // ss
            {{1, 2u}, {-3, 4u}}, // objs
            {},                  // aa
            {},
            {},
            {},
            {},
            {} // nested fields
        },
        ArrayWriteCase{
            "ArrayOfArrays",
            bytes_arrays_case9,
            {}, // i64
            {},
            {},
            {},                    // u64, f32, f64
            {},                    // ss
            {},                    // objs
            {{1, 2, 3}, {}, {-1}}, // aa
            {},
            {},
            {},
            {},
            {} // nested fields
        },
        // New deep/nested tests:
        ArrayWriteCase{"DeepNested_AllTypes1",
                       bytes_arrays_case10,
                       {1, -2, 3},                    // i64
                       {0ULL, 999999999ULL},          // u64
                       {1.0f, -2.5f},                 // f32
                       {3.141592653589793, -1.0e100}, // f64
                       {"root", "nested", ""},        // ss
                       {{-1, 0u}, {0, 42u}},          // objs
                       {{}, {1, 2, 3}, {-10, -20}},   // aa
                       {                              // aa_f64
                        {0.0, 1.5, -2.25},
                        {},
                        {1.0e-10, -1.0e-10}},
                       {// aa_bool
                        {true, false, true},
                        {},
                        {false}},
                       {// aa_objs
                        {{1, 1u}, {2, 2u}},
                        {},
                        {{-100, 123456u}}},
                       {// aa_ss
                        {"a", "b", "c"},
                        {},
                        {"\u03b1", "\u03b2"}},
                       {// aaa_f32
                        {{1.0f}, {2.0f, 3.0f}},
                        {},
                        {{-1.5f, -2.5f, -3.5f}, {0.0f}}}},
        ArrayWriteCase{"DeepNested_AllTypes2",
                       bytes_arrays_case11,
                       {},                                               // i64
                       {},                                               // u64
                       {},                                               // f32
                       {0.0, -0.0},                                      // f64
                       {"", "deep", "deeper"},                           // ss
                       {},                                               // objs
                       {{100, 200, 300, 400}, {}, {-1, -1, -1, -1, -1}}, // aa
                       {// aa_f64
                        {1.0, 2.0, 3.0, 4.0},
                        {1.0e-3, 1.0e3},
                        {}},
                       {// aa_bool
                        {true},
                        {false, false, true, false},
                        {}},
                       {// aa_objs
                        {{7, 7u}, {8, 8u}, {9, 9u}}},
                       {// aa_ss
                        {"nested", "strings"},
                        {},
                        {"x", "y", "z", "w"}},
                       {// aaa_f32
                        {{0.0f, 1.0f}, {-1.0f, -2.0f, -3.0f}, {10.0f}},
                        {{}, {3.14f, 2.71f}, {42.0f, -42.0f, 0.0f, 0.5f}},
                        {}}}),
    ArrayWriteCaseName());
